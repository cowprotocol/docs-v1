<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-solvers/in-depth-solver-specification/the-batch-auction-optimization-problem" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">The Batch Auction Optimization Problem | CoW Protocol Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cowprotocol.github.io/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://cowprotocol.github.io/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://cowprotocol.github.io/docs/docs/solvers/in-depth-solver-specification/the-batch-auction-optimization-problem"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="The Batch Auction Optimization Problem | CoW Protocol Documentation"><meta data-rh="true" name="description" content="In this section, we describe all the different components of the optimization problem that needs to be solved within each batch."><meta data-rh="true" property="og:description" content="In this section, we describe all the different components of the optimization problem that needs to be solved within each batch."><link data-rh="true" rel="icon" href="/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cowprotocol.github.io/docs/docs/solvers/in-depth-solver-specification/the-batch-auction-optimization-problem"><link data-rh="true" rel="alternate" href="https://cowprotocol.github.io/docs/docs/solvers/in-depth-solver-specification/the-batch-auction-optimization-problem" hreflang="en"><link data-rh="true" rel="alternate" href="https://cowprotocol.github.io/docs/docs/solvers/in-depth-solver-specification/the-batch-auction-optimization-problem" hreflang="x-default"><link rel="stylesheet" href="/docs/assets/css/styles.9bdc75da.css">
<link rel="preload" href="/docs/assets/js/runtime~main.4b31c2d6.js" as="script">
<link rel="preload" href="/docs/assets/js/main.412c5ce1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CoW Protocol Documentation</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/docs">Tutorial</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs">CoW Protocol Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/docs/cow-sdk">CoW SDK</a><button aria-label="Toggle the collapsible sidebar category &#x27;CoW SDK&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/docs/front-end/cow-explorer">front-end</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/docs/off-chain-services/api">off-chain-services</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/docs/overview/batch-auctions">overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/docs/smart-contracts/allow-list-authenticator-1">smart-contracts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/docs/solvers">Introduction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Introduction&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/docs/solvers/how-to-build-a-solver">How to Build a Solver</a><button aria-label="Toggle the collapsible sidebar category &#x27;How to Build a Solver&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification">In-depth: Solver specification</a><button aria-label="Toggle the collapsible sidebar category &#x27;In-depth: Solver specification&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/getting-notified-about-the-ranking">Getting notified about the ranking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/input-batch-auction-instances">Input: Batch auction instances</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/output-batch-auction-solutions">Output: Batch auction solutions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/sample-test-instances">Sample Test Instances</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/slippage-accounting">Slippage accounting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/social-consensus-rules">Social Consensus Rules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/solver-auction-and-rewards">Solver Auction and Rewards</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/docs/solvers/in-depth-solver-specification/the-batch-auction-optimization-problem">The Batch Auction Optimization Problem</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/docs/tutorials/build-on-top-of-cow-protocol">tutorials</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/docs/solvers"><span itemprop="name">Introduction</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/docs/solvers/in-depth-solver-specification"><span itemprop="name">In-depth: Solver specification</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">The Batch Auction Optimization Problem</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>The Batch Auction Optimization Problem</h1><p>In this section, we describe all the different components of the optimization problem that needs to be solved within each batch.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="user-orders">User Orders<a href="#user-orders" class="hash-link" aria-label="Direct link to User Orders" title="Direct link to User Orders">​</a></h2><p>Suppose that there are $$<!-- -->{<!-- -->1,2,...k<!-- -->}<!-- -->$$ tokens. From a high-level perspective, we can define a user order as an <em>acceptance set</em> $$S \subset \mathbb R^k$$ specifying the trades a user is willing to accept (where negative entries of a vector represent tokens sold, while positive entries represent tokens bought). So, for example, if $$k=2$$ and $$\begin{bmatrix} x <!-- -->\<!-- -->-y \end{bmatrix}\in S$$ then a user is happy to receive <em>x</em> units of token 1 in exchange for <em>y</em> units of token 2 (note: this is all from the user&#x27;s perspective and is therefore net of fees).</p><p>Clearly,  $$\mathbb R^k<em>+ \subset S$$, that is, a user is always willing to accept an order in which they receive a positive amount of tokens without paying anything. Similarly, $$\mathbb R^k</em>{-} \cap S = 0$$ because no user would accept to pay tokens without receiving anything. The interesting elements of the acceptance set are, therefore, those with at least one positive entry and at least one negative entry. We also assume that $$0 \in S$$, that is, when submitting an order a user accepts that the order may not be filled.<!-- --> </p><p>To each order $$S$$ we may assign a <em>utility function</em> $$U<em>S:S\rightarrow \mathbb R$$ specifying a numerical value to each trade in the acceptance set, to be interpreted as &quot;how good&quot; a trade is from the point of view of the user who submitted order _S</em>. By definition $$U_S(0)=0$$.</p><p>Practically speaking, CoW Protocol allows only some types of orders, which we can think of as constraints on the set <em>S</em> that a user can submit<em>.</em> One such constraint is that only pairwise swaps are allowed, that is, all vectors in $$S$$  have zeros in $$k-2$$ dimensions. Furthermore, each order must fit within one of the categories we now discuss. To simplify notation, when discussing these categories we assume that $$k=2$$.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="limit-sell-orders">Limit Sell Orders<a href="#limit-sell-orders" class="hash-link" aria-label="Direct link to Limit Sell Orders" title="Direct link to Limit Sell Orders">​</a></h4><p>A <em>limit sell order</em> specifies a maximum sell amount of a given token <em>Y</em> &gt; 0, a buy token, and a limit price $$\pi$$, that corresponds to the worst-case exchange rate that the user is willing to settle for. They can be fill-or-kill whenever the executed sell amount must be Y (or nothing). They can be partially fillable if the executed sell amount can be smaller or equal to Y.  Formally, if <em>x</em> denotes the (proposed) buy amount and <em>y</em> denotes the (proposed) sell amount of the order, a fill-or-kill limit sell order has the form</p><p>$$S=\left<!-- -->{<!-- -->\begin{bmatrix} x <!-- -->\<!-- -->-y \end{bmatrix}~~s.t. ~~\frac{y}{\pi}\leq x \mbox{ and } y\in<!-- -->{<!-- -->0,Y<!-- -->}<!-- --> \right<!-- -->}<!-- -->,$$</p><p>and a partially-fillable sell order has the form</p><p>$$S= \left <!-- -->{<!-- --> \begin{bmatrix} x <!-- -->\<!-- -->-y \end{bmatrix} ~~s.t. ~~\frac{y}{\pi} \leq x \mbox{ and } y \in <!-- -->[0,Y]<!-- --> \right <!-- -->}<!-- -->.$$</p><p>In both cases, the utility function is defined as</p><p>$$U(x,-y)=(x-y / \pi)p(b)$$,</p><p>where $$(x-y / \pi)$$ is the additional amount of buy tokens received by the user relative to the case in which they trade at the limit price, and $$p(b)$$ is the price of the buy token relative to a numéraire (in our case ETH) and is externally provided (i.e., by an oracle). The function $$U(x,-y)$$ is therefore expressed in units of the numéraire and is always non-negative.</p><p>A final observation is that orders can be valid over multiple batches. For a fill-or-kill, this means that an order that is not filled remains valid for a certain period (specified by the user). For a partially-fillable order, this also means that only a fraction of it may be executed in any given batch.<!-- --> </p><p><strong>Limit Buy Orders</strong></p><p>A <em>limit buy order</em> is specified by a maximum buy amount <em>X</em> &gt; 0 and a limit price $$\pi$$ corresponding to the worst-case exchange rate the user is willing to settle for. With <em>x</em> denoting the buy amount and <em>y</em> denoting the sell amount of the order, fill-or-kill limit buy orders have the form</p><p>$$S = \left<!-- -->{<!-- -->\begin{bmatrix} x <!-- -->\<!-- -->-y \end{bmatrix}<del>s.t.</del> y \leq x \cdot \pi \mbox{ and }\;\; x \in<!-- -->{<!-- -->0, X<!-- -->}<!-- --> \right<!-- -->}<!-- -->$$</p><p>while partially-fillable limit buy orders have the form</p><p>$$S = \left<!-- -->{<!-- -->\begin{bmatrix} x <!-- -->\<!-- -->-y \end{bmatrix}<del>s.t.</del> y \leq x \cdot \pi \mbox{ and }\;\; x \in<!-- -->[0, X]<!-- --> \right<!-- -->}<!-- -->.$$</p><p>Again, the utility function is defined as</p><p> <!-- -->$$U(<!-- -->{<!-- -->x,-y<!-- -->}<!-- -->)=(x \cdot \pi-y)p(s)$$,</p><p>where $$p(s)$$ is the price of the sell token relative to a numéraire and is externally provided. Also here, orders can be executed over multiple batches.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="liquidity-orders">Liquidity Orders<a href="#liquidity-orders" class="hash-link" aria-label="Direct link to Liquidity Orders" title="Direct link to Liquidity Orders">​</a></h2><p>Liquidity orders are orders not submitted by users. They represent sources of liquidity that are available to a solver, for example, automated market makers or private liquidity pools. They look identical to user orders, in the sense that each liquidity order can be represented by an acceptance set $$L \subset \mathbb R^k$$. The main difference to user orders is that the utility function of a liquidity order is always zero.<!-- --> </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fees-">Fees<!-- --> <a href="#fees-" class="hash-link" aria-label="Direct link to fees-" title="Direct link to fees-">​</a></h2><p>Each user order has an associated fee paid to the protocol. At a high level, these fees can be represented by a function that, for a given order $$S$$ maps all possible trades to a positive vector of tokens, that is $$f<em>S:S \rightarrow \mathbb R^k</em>+$$   with $$f_S(0)=0$$.</p><p>From the practical viewpoint, for market fill-or-kill orders, the fee is always in the sell token and is pre-specified: it is an estimate of the cost of executing an order and is explicitly shown to the user before the order is submitted. Instead, (long-standing) limit orders are &quot;feeless&quot; from the user&#x27;s perspective: users are guaranteed a limit price without specifying how fees will be calculated. For fill-or-kill limit orders, the protocol computes a fee each time such an order enters a batch auction, while for partially-fillable limit orders, solvers are the ones that need to propose a fee. In this latter case, the expectation is that this fee should equal the cost of execution of this trade in isolation. The fee of limit orders is again in the sell token.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution">Solution<a href="#solution" class="hash-link" aria-label="Direct link to Solution" title="Direct link to Solution">​</a></h2><p>Solvers propose solutions to the protocol, where a solution is a set of trades to execute. Formally, suppose that there are $$I$$ users and <em>J</em> liquidity sources. A solution is a list of trades $$<!-- -->{<!-- -->o_1, o_2, ...o_I, l_1, l_2, ..., l_J<!-- -->}<!-- -->$$ one per user and one per liquidity source such that</p><ul><li><strong>Maximum size of solution:</strong> The total number of executed orders and AMMs does not exceed a certain number within each batch due to limitations regarding the size of a block on the blockchain.</li><li><strong>Incentive compatibility and feasibility:</strong> the trades respect the user and liquidity orders, that is, $$o_i\in S_i<del>\forall i\leq I$$  and $$l_j \in L_j</del>\forall j\leq J$$.</li><li><strong>Uniform clearing prices:</strong> all users must face the same prices. Importantly, this constraint is defined at the moment when the swap occurs. So, for example, suppose user <em>i</em> receives <em>x</em> units of token 1 in exchange for <em>y</em> units of token 2 and that the protocol takes a fee in the sell token $$f<em>2$$. Define $$p</em>{1,2}=\frac{y-f<em>2}{x}$$ as the price at which the swap occurs. Uniform clearing prices means that $$p</em>{1,2}$$ is the same for all users swapping token 1 and token 2. Furthermore, prices must be consistent, in the sense that for any three tokens 1, 2, and 3, if $$p<em>{1,2},~ p</em>{2,3}, ~p<em>{1,3}$$ are well-defined, then it must be that $$p</em>{1,2}\cdot p<em>{2,3}=p</em>{1,3}$$. Note that this implies that prices can be expressed with respect to a common numéraire, giving rise to a uniform price clearing vector $$p$$.</li><li><strong>Token conservation per token:</strong> No token amounts can be created or destroyed. In other words, for every token, the total amount sold must be equal to the total amount bought of this token.</li><li><strong>Social consensus rules:</strong> These are a set of principles that solvers should follow, which were voted by CIPs. They are specified on the page Social Consensus Rules.</li></ul><p>Note that systematic violation of these rules might lead to penalizing or even slashing (if the DAO decides so).</p><p>From the protocol viewpoint, each solution that satisfies the above constraints has a <em>quality</em> given by the sum of the utility generated, and the fees paid to the protocol:</p><p>$$\sum_o ​U(o)+p\cdot \sum_o​f(o)$$,</p><p>where <em>p</em> is a vector of externally-determined prices used to express all fees in terms of the common numéraire.<!-- --> </p><p>Finally, solvers compete for the right to settle a batch by participating in an auction, aiming to implement the solution with the highest quality at the lowest possible cost to the protocol. For more details, see the page <a href="/docs/docs/solvers/in-depth-solver-specification/solver-auction-and-rewards">Solver Auction and Rewards</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/solvers/in-depth-solver-specification/the-batch-auction-optimization-problem.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/docs/solvers/in-depth-solver-specification/solver-auction-and-rewards"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Solver Auction and Rewards</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/docs/tutorials/build-on-top-of-cow-protocol"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Build on top of CoW Protocol</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#user-orders" class="table-of-contents__link toc-highlight">User Orders</a></li><li><a href="#liquidity-orders" class="table-of-contents__link toc-highlight">Liquidity Orders</a></li><li><a href="#fees-" class="table-of-contents__link toc-highlight">Fees </a></li><li><a href="#solution" class="table-of-contents__link toc-highlight">Solution</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docs/assets/js/runtime~main.4b31c2d6.js"></script>
<script src="/docs/assets/js/main.412c5ce1.js"></script>
</body>
</html>